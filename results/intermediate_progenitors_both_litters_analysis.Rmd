---
title: "intermediate_progenitor_both_litters_analysis"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(tidyverse)
options(Seurat.memsafe = TRUE)
```
# Intermediate progenitors analysis

The aim of this analysis is to sub-cluster intermediate progenitors to get a higher resolution clustering of this cell population. Using both samples to get DE genes.

# Preprocessing
Read seurat object
```{r}
seurat_obj <- readRDS("../data_output/surat_objects/run_8nov21/Mm_merged_mito_mito_integrated.rds")

```
New cluster assignments
```{r}
DefaultAssay(seurat_obj) <- "integrated"
seurat_obj <- FindNeighbors(object = seurat_obj, dims = 1:20)
seurat_obj <- FindClusters(object = seurat_obj, resolution = 1.1)

```
```{r}
library(clusterProfiler)
library(org.Mm.eg.db)
DefaultAssay(seurat_obj) <- "RNA"


tbr2 <- bitr("Eomes",fromType = "SYMBOL",toType = "ENSEMBL",OrgDb = org.Mm.eg.db)$ENSEMBL

FeaturePlot(object = seurat_obj,features = tbr2) +
  theme(aspect.ratio = 1) 

VlnPlot(object = seurat_obj, features = tbr2) +
  theme(aspect.ratio = 0.75)
```
```{r}
tbr2_clusters <- c("2","8","13","16","17","21")
```

# Filtering

Keep cells from clusters annotated as tbr2+ intermediate progenitor neurons.
```{r}
seurat_obj <- seurat_obj[,seurat_obj$seurat_clusters %in% tbr2_clusters]
```


# Clustering
```{r}
DefaultAssay(seurat_obj) <- "integrated"

seurat_obj <- RunPCA(seurat_obj, verbose = FALSE, npcs = 100)

seurat_obj <- RunUMAP(seurat_obj, reduction = "pca", dims = 1:20)

seurat_obj <- FindNeighbors(object = seurat_obj, dims = 1:20)
seurat_obj <- FindClusters(object = seurat_obj, resolution = 1.1)

```
```{r}
saveRDS(seurat_obj,file = "../data_output/surat_objects/tbr2_both_litters_seurat_obj.Rds")
```

# Visualizing UMAP
```{r}
DimPlot(seurat_obj, label = TRUE)
```

```{r}
DimPlot(seurat_obj, label = TRUE,split.by = "geno")

```
# Compare 4 litter vs 2 litter clusters
```{r}
source("../scripts/compare_clusters_jaccard.R")

litter4_metadata <- seurat_obj@meta.data
litter2_metadata <- readRDS(file = "../data_output/surat_objects/tbr2_litter2_seurat_obj.Rds")@meta.data

plot_cluster_jaccard_matrix(get_cluster_jaccard_df(litter4_metadata, litter2_metadata)) + xlab("All All samples") + ylab("Litter 2")

```


# Get markers
```{r}
DefaultAssay(seurat_obj) <- "RNA"
seurat_obj <- NormalizeData(seurat_obj)

seurat_obj_conserved_markers_list <- lapply(levels(Idents(seurat_obj)), FindConservedMarkers, object = seurat_obj,grouping.var = "geno", verbose = FALSE )

names(seurat_obj_conserved_markers_list) <- levels(Idents(seurat_obj))

seurat_obj_conserved_markers_list_df <- do.call(rbind,imap(seurat_obj_conserved_markers_list, function(.x,.y) {
  .x <- rownames_to_column(.x,var = "ensembl")
  .x$cluster <- .y
  return(.x)
}))

top30_markers <- seurat_obj_conserved_markers_list_df %>%
  group_by(cluster) %>%
  top_n(30,XP_avg_log2FC)

library(clusterProfiler)
library(org.Mm.eg.db)

symbol_map <- bitr(top30_markers$ensembl,fromType = "ENSEMBL",toType = "SYMBOL",OrgDb = org.Mm.eg.db)

symbol_map <- symbol_map[!duplicated(symbol_map$ENSEMBL),]

top30_markers <- left_join(top30_markers,symbol_map, by =c("ensembl" = "ENSEMBL"))

write.csv(top30_markers, "../data_output/surat_objects/tbr2_all_samples_top30lfc_markers.csv")

```

# Tbr2
```{r}
library(clusterProfiler)
library(org.Mm.eg.db)

tbr2 <- bitr("Eomes",fromType = "SYMBOL",toType = "ENSEMBL",OrgDb = org.Mm.eg.db)$ENSEMBL

FeaturePlot(object = seurat_obj,features = tbr2) +
  theme(aspect.ratio = 1) 

VlnPlot(object = seurat_obj, features = tbr2) +
  theme(aspect.ratio = 0.75)
```


# Fzd8 
```{r}

fzd8 <- bitr("Fzd8",fromType = "SYMBOL",toType = "ENSEMBL",OrgDb = org.Mm.eg.db)$ENSEMBL

FeaturePlot(object = seurat_obj,features = fzd8) +
  theme(aspect.ratio = 1)

VlnPlot(object = seurat_obj, features = fzd8) +
  theme(aspect.ratio = 0.75)
```
# Malat
```{r}

malat1 <- bitr("Malat1",fromType = "SYMBOL",toType = "ENSEMBL",OrgDb = org.Mm.eg.db)$ENSEMBL

seurat_obj$malat_percent <- PercentageFeatureSet(seurat_obj,features = malat1)

FeaturePlot(object = seurat_obj,features = "malat_percent") +
  theme(aspect.ratio = 1)

VlnPlot(object = seurat_obj, features = "malat_percent") +
  theme(aspect.ratio = 1)
```

```{r}
seurat_obj@meta.data %>%
  as_data_frame() %>%
  ggplot(aes(seurat_clusters, fill =  geno)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(type = "qual",palette = 7)

```

```{r}
tabled_n_by_clust <- table(seurat_obj@meta.data$seurat_clusters,seurat_obj@meta.data$geno)
relative_tabled_n_by_clust <- tabled_n_by_clust
relative_tabled_n_by_clust[,"WT"] <- relative_tabled_n_by_clust[,"WT"]/sum(relative_tabled_n_by_clust[,"WT"])
relative_tabled_n_by_clust[,"XP"] <- relative_tabled_n_by_clust[,"XP"]/sum(relative_tabled_n_by_clust[,"XP"])

as.data.frame(relative_tabled_n_by_clust) %>%
  mutate(seurat_clusters = Var1,
         geno = Var2) %>%
  ggplot(aes(seurat_clusters,Freq, fill =  geno)) +
  geom_col(position = "dodge") +
  scale_fill_brewer(type = "qual",palette = 7)

```

EdgeR
```{r}
library(scater)
library(edgeR)
sce_obj <- as.SingleCellExperiment(seurat_obj)

abundances <- table(seurat_obj@meta.data$seurat_clusters,seurat_obj@meta.data$sample)

abundances <- unclass(abundances) 


extra_info <- colData(sce_obj)[match(colnames(abundances), sce_obj$sample),]

extra_info$geno <- factor(extra_info$geno)
y_ab <- DGEList(abundances, samples=extra_info)

design <- model.matrix(~ geno, y_ab$samples)

y_ab <- calcNormFactors(y_ab)

y_ab <- estimateDisp(y_ab, design, trend="none")
fit_ab <- glmQLFit(y_ab, design, robust=TRUE, abundance.trend=FALSE)

res <- glmQLFTest(fit_ab, coef=ncol(design))
summary(decideTests(res))

res$table
```


```{r}

as.data.frame(relative_tabled_n_by_clust) %>%
  mutate(seurat_clusters = Var1,
         geno = Var2) %>%
  filter(seurat_clusters %in% rownames(res$table[res$table$logFC > 0.5,])) %>%
  ggplot(aes(seurat_clusters,Freq, fill =  geno)) +
  geom_col(position = "dodge") +
  scale_fill_brewer(type = "qual",palette = 7)

```

# Cell cycle
```{r eval = FALSE}
set.seed(100)

library(scran)
mm.pairs <- readRDS(system.file("exdata", "mouse_cycle_markers.rds", 
    package="scran"))

# Using Ensembl IDs to match up with the annotation in 'mm.pairs'.
assignments <- cyclone(sce_obj, mm.pairs, gene.names=rownames(sce_obj))
saveRDS(assignments,"../data_output/osca_objects/cellcycle_assignments_tbr2_all_litters.rds")
```


```{r}
plot(assignments$score$G1, assignments$score$G2M,
    xlab="G1 score", ylab="G2/M score", pch=16)

```

```{r}
seurat_obj$G1 <- assignments$normalized.scores$G1
seurat_obj$S <- assignments$normalized.scores$S
seurat_obj$G2M <- assignments$normalized.scores$G2M
seurat_obj$phases <- assignments$phases

```

```{r}
FeaturePlot(seurat_obj,features = "G1")
FeaturePlot(seurat_obj,features = "G2M")
FeaturePlot(seurat_obj,features = "S")

```

```{r}
DimPlot(seurat_obj,group.by  = "phases")

```

```{r}
table(seurat_obj$seurat_clusters,paste(seurat_obj$phases,seurat_obj$geno,sep = "_"))[c("8"),]
```


# Differential expression
```{r}
library(scran)
library(scater)
sce_obj <- SingleCellExperiment(assays = list(counts = seurat_obj@assays$RNA@counts), 
                           colData = DataFrame(seurat_obj@meta.data))
summed <- aggregateAcrossCells(sce_obj, 
    id=colData(sce_obj)[,c("seurat_clusters","sample")])

summed$batch <- substr(summed$sample,3,3)
# Creating up a DGEList object for use in edgeR:
library(edgeR)

de_results <- pseudoBulkDGE(summed,
                            sample = summed$sample,
    label=summed$seurat_clusters,
    design= ~ batch + geno,
    contrast = "genoXP",
    condition=summed$geno
)
```

```{r}
is_de <- decideTestsPerLabel(de_results, threshold=0.05)
summarizeTestsPerLabel(is_de)

```


```{r}
lognormsummed <- summed
sizeFactors(lognormsummed) <- NULL
lognormsummed <- logNormCounts(lognormsummed)

str_length(rownames(de_results$`0`))
```

```{r}
de_results_df <- do.call(rbind,lapply(names(de_results),
      function(title,x) {
        x <- x[[title]]
        x <- as.data.frame(x)
        x$cluster <- title
        x <- x %>%
          rownames_to_column(var = "ENSEMBL")
        return(x)
      }, x = de_results))

ens2symbol <- clusterProfiler::bitr(de_results_df$ENSEMBL,fromType = "ENSEMBL",toType = "SYMBOL",OrgDb = org.Mm.eg.db)

de_results_df <- left_join(de_results_df, ens2symbol,by= "ENSEMBL")
de_results_df <- drop_na(de_results_df)
```

```{r}
de_results_df %>%
  ggplot(aes(logCPM, logFC, color = FDR < 0.05)) +
  geom_point(size = 0.5, pch = 1) +
  scale_color_manual(values = c("TRUE" = "red","FALSE"="darkgray")) +
  theme_light() +
  theme(aspect.ratio = 1) +
  facet_wrap(~cluster) +
  ggrepel::geom_text_repel(mapping = aes(label = SYMBOL),
                           data = de_results_df %>%
                             filter(FDR < 0.05),
                           color = "black",
                           max.overlaps = 30,
                           size = 3) 

```
Show only WNT signaling genes
```{r}

mmu_kegg <- clusterProfiler::download_KEGG(species ="mmu")

wnt_pathway <- mmu_kegg$KEGGPATHID2NAME[str_detect(mmu_kegg$KEGGPATHID2NAME$to,"W"), ]

wnt_pathway_entrez_genes <- mmu_kegg$KEGGPATHID2EXTID %>%
  filter(from == wnt_pathway$from )

wnt_pathway_genes <- clusterProfiler::bitr(wnt_pathway_entrez_genes$to,OrgDb = org.Mm.eg.db,fromType = "ENTREZID",toType=c("ENSEMBL","SYMBOL"))


```

```{r}
de_results_df %>%
  ggplot(aes(logCPM, logFC, color = FDR < 0.05 & ENSEMBL %in% wnt_pathway_genes$ENSEMBL )) +
  geom_point(size = 0.5, pch = 1) +
  scale_color_manual(values = c("TRUE" = "red","FALSE"="darkgray")) +
  theme_light() +
  theme(aspect.ratio = 1,legend.position = "none") +
  facet_wrap(~cluster) +
  ggrepel::geom_text_repel(mapping = aes(label = SYMBOL),
                           data = de_results_df %>%
                             filter(FDR < 0.05 & ENSEMBL %in% wnt_pathway_genes$ENSEMBL),
                           color = "black",
                           max.overlaps = 30,
                           size = 3) 

```


```{r}
DefaultAssay(seurat_obj) <- "RNA"

seurat_obj <- NormalizeData(seurat_obj)

Uba52 <- bitr("Uba52",fromType = "SYMBOL",toType = "ENSEMBL",OrgDb = org.Mm.eg.db)$ENSEMBL

FeaturePlot(object = seurat_obj,features = Uba52,split.by = "geno") +
  theme(aspect.ratio = 1)

VlnPlot(object = seurat_obj, features = Uba52,split.by = "geno") +
  theme(aspect.ratio = 0.75)
```
```{r}

H3c2 <- bitr("H3c2",fromType = "SYMBOL",toType = "ENSEMBL",OrgDb = org.Mm.eg.db)$ENSEMBL

FeaturePlot(object = seurat_obj,features = H3c2,split.by = "geno") +
  theme(aspect.ratio = 1)

VlnPlot(object = seurat_obj, features = H3c2,split.by = "geno") +
  theme(aspect.ratio = 0.75)
```
